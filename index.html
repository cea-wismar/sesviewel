<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>SESViewEl</title>
    <link rel="stylesheet" href="./index.css">
  </head>
  <body>
    <p><center><h3>SESViewEl - System Entity Structure View in Node.js / Electron</h3></center></p>
    <p align="right">A socket server is started on port 54545. SESToPy can connect to this server now. Exit the program here: <input name="exit" id="exit" type="button" size="20" value="Exit"></p>

    <!--
    We are using Node.js <script>document.write(process.versions.node)</script>,
    Chromium <script>document.write(process.versions.chrome)</script>,
    and Electron <script>document.write(process.versions.electron)</script>.
    -->

    <table style="display: inline-block"; border=0>
      <tbody>
        <tr valign="top">
          <td><div style="display:inline-block;" id="globals"></div></td>
          <td><input name="Show/Hide Node Attributes" id="showhidenodeattrib" type="button" size="20" value="Show/Hide Node Attributes" onclick="showNodeSpecAttrib();"></td>
          <td><div style="display:inline-block;" id="nodeSpecificAttributes"></div></td>
        </tr>
      </tbody>
    </table>
  </body>

  <script>
    //requires for this file
    //module provides an asynchronous network API
    var net = require('net');
    //module for the creation of an application
    const remote = require('electron').remote;
    //module for the libraries for printing the graph
    var d3 = require("d3");
    //script for creating d3 trees from the XML
    var conv = require('./xml_converter');
    //script for the presentation of the graph
    var presenter  = require('./presentation')

    //event listener on exit button
    document.querySelector('#exit').addEventListener('click', exitFun);

    //start the server
    server();

    //set global variables
    var show_allAttribString = "";
    var nodesSpecAttribShown = false;
    var nSA = [];

    //--------------------------------------------------------------------

    //window resize event -> recalculate presentation of the node specific attributes
    window.addEventListener('resize', function(e){
      e.preventDefault();
      presNodeSpecAttr(nSA);
    })

    //--------------------------------------------------------------------

    //presentation with d3

    //set the dimensions and margins of the diagram
    var margin = {top: 60, right: 90, bottom: 30, left: 90},
        width  = 1200 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;

    //append the svg object to the body of the page
    //appends a 'group' element to 'svg'
    //moves the 'group' element to the top left margin
    var svg = d3.select("body").append("svg")
                .attr("width", width + margin.right + margin.left)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("display", "none");

    // declares a tree layout and assigns the size
    var treemap = d3.tree().size([width, height]);
    //w and h are turned, since the presentation is turned

    //--------------------------------------------------------------------

    //presentation of the globals
    function presGlob(sesvars, semcons) {
      var show_globals = [];
      show_globals.push('<table style="display: inline-block"; border=1>');
      //show_globals.push('<table style="float: left"; border=1>');
        show_globals.push('<thead>');
          show_globals.push('<tr><th align=left bgcolor=#AAAAAA>SES variables</th><th align=left bgcolor=#AAAAAA>semantic conditions</th></tr>');
        show_globals.push('</thead>');
        show_globals.push('<tbody>');
          show_globals.push('<tr><td bgcolor=#AAAAAA>' + sesvars + '</td><td bgcolor=#AAAAAA>' + semcons +'</td></tr>');
        show_globals.push('</tbody>');
      show_globals.push('</table>');

      var show_globalsString = "";
      for (var i=0; i<show_globals.length; i++) {
        show_globalsString = show_globalsString + show_globals[i];
      }

      var globEl = document.getElementById("globals");
      globEl.innerHTML = show_globalsString;
    }

    //presentation of the node specific attributes
    function presNodeSpecAttr(nodeSpecificAttributes) {
      //write in global variable -> make a copy
      nSA = JSON.parse(JSON.stringify(nodeSpecificAttributes));
      show_allAttribString = "";

      //prepare -> <br /> to new array entry
      for (var i=0; i<nodeSpecificAttributes.length; i++) {
        nodeSpecificAttributes[i][1] = nodeSpecificAttributes[i][1].split("<br />");
        nodeSpecificAttributes[i][1].splice(-1,1);
      }

      //get the window size
      var windowSize = remote.getCurrentWindow().webContents.getOwnerBrowserWindow().getBounds();
      var width = windowSize.width;

      //get the longest entry and the number of entries
      var longestEntry = 0;
      var numEntries = 0;
      for (var i=0; i<nodeSpecificAttributes.length; i++) {
        var nlen = nodeSpecificAttributes[i][0].length;        
        numEntries = numEntries + nodeSpecificAttributes[i][1].length;
        for (var j=0; j<nodeSpecificAttributes[i][1].length; j++) {
          var elen = nodeSpecificAttributes[i][1][j].length;
          if (nlen + elen > longestEntry) {
            longestEntry = nlen + elen + 15;  //15 for the table and the space
          }
        }
      }

      //decide how many tables and how many attributes per table
      var numTablesFit = Math.floor(width / (longestEntry * 8));  //8 because one letter is not one pixel
      var attributesPerTable = Math.ceil(numEntries / numTablesFit);

      //now create the tables
      var tables = [];
      var table = [];
      var tabl = [];
      var entryCount = 0;
      for (var i=0; i<nodeSpecificAttributes.length; i++) {
        if (entryCount < attributesPerTable) {
          tabl.push(nodeSpecificAttributes[i][0]);
          for (var j=0; j<nodeSpecificAttributes[i][1].length; j++) {
            tabl.push(nodeSpecificAttributes[i][1][j]);
            entryCount += 1;
          }
          table.push(tabl);
          tabl = [];
        } else {
          tables.push(table);
          table = [];
          entryCount = 0;
        }
      }
      if (table.length > 0) {
        tables.push(table);
      }
      
      //build the HTML code for the tables
      var show_allAttrib = [];

      show_allAttrib.push('<table style="display: inline-block"; border=0>');
        show_allAttrib.push('<tbody>');
          show_allAttrib.push('<tr valign="top">');

            for (var i=0; i<tables.length; i++) {
              show_allAttrib.push('<td>');
              
              var show_attrib = [];
              show_attrib.push('<table style="display: inline-block"; border=1>');    //show_attrib.push('<table style="float: left"; border=1>');
                show_attrib.push('<thead>');
                  show_attrib.push('<tr><th align=left bgcolor=#EEEEEE>Nodename</th><th align=left bgcolor=#EEEEEE>Attributes</th></tr>');
                show_attrib.push('</thead>');
                for (var j=0; j<tables[i].length; j++) {
                  show_attrib.push('<tbody>');
                    var attrstring = "";
                    for (var k=1; k<tables[i][j].length; k++) {
                      if (attrstring != "") {
                        attrstring = attrstring + "<br />" + tables[i][j][k];
                      } else {
                        attrstring = tables[i][j][k];
                      }
                    }
                    show_attrib.push('<tr><td bgcolor=#EEEEEE>' + tables[i][j][0] + '</td><td bgcolor=#EEEEEE>' + attrstring +'</td></tr>');
                  show_attrib.push('</tbody>');
                }
              show_attrib.push('</table>');

              show_allAttrib.push(show_attrib);
              show_allAttrib.push('</td>');
            }

          show_allAttrib.push('</tr>');
        show_allAttrib.push('</tbody>');
      show_allAttrib.push('</table>');

      var show_allAttribArray = [];
      for (var i=0; i<show_allAttrib.length; i++) {
        show_allAttribArray = show_allAttribArray.concat(show_allAttrib[i]);
      }

      for (var i=0; i<show_allAttribArray.length; i++) {
        show_allAttribString = show_allAttribString + show_allAttribArray[i];
      }

      //show on UI if it shall be shown
      if (nodesSpecAttribShown) {
        var nsaEl = document.getElementById("nodeSpecificAttributes");
        nsaEl.innerHTML = show_allAttribString;
      }
      
    }

    function showNodeSpecAttrib() {
      if (!nodesSpecAttribShown) {
        var nsaEl = document.getElementById("nodeSpecificAttributes");
        nsaEl.innerHTML = show_allAttribString;
        nodesSpecAttribShown = true;
      } else {
        var nsaEl = document.getElementById("nodeSpecificAttributes");
        nsaEl.innerHTML = "";
        nodesSpecAttribShown = false;
      } 
    }

    //--------------------------------------------------------------------

    function server() {
      // Keep track of the clients
      var clients = [];

      // Start a TCP Server
      net.createServer(function (socket) {

        // Identify this client
        socket.name = socket.remoteAddress + ":" + socket.remotePort;

        // Put this new client in the list
        clients.push(socket);

        // Handle incoming messages from clients.
        socket.on('data', function (data) {
          //read question and create reply
          var rcvstring = new TextDecoder("utf8").decode(data);  //decode
          //execute xml tree to d3 tree conversion
          var retval = conv.treeData(rcvstring);
          var treeDat = retval[0];
          var sesvars = retval[1];
          var semcons = retval[2]; 
          var nodeSpecificAttributes = retval[3];
          //execute script for presentation
          presenter.createPicture(treeDat);
          //execute function for presentation of the globals
          presGlob(sesvars, semcons);
          //execute function for presentation of the node specific attributes
          presNodeSpecAttr(nodeSpecificAttributes); 
        });

        // Remove the client from the list when it leaves
        socket.on('end', function () {
          clients.splice(clients.indexOf(socket), 1);
        });

      }).listen(54545);
    }

    function exitFun() {
        const remote = require('electron').remote;
        let w = remote.getCurrentWindow();
        w.close();
    }

  </script>
  
</html>